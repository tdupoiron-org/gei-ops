name: GEI Migration Workflow

on:
  issues:
    types: [opened]

permissions:
  issues: write
  contents: read

jobs:
  process-migration:
    if: contains(github.event.issue.labels.*.name, 'migration') && contains(github.event.issue.labels.*.name, 'pending')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Parse issue form
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            
            // Parse the issue form data
            const parseField = (fieldName) => {
              const regex = new RegExp(`### ${fieldName}\\s*([\\s\\S]*?)(?=###|$)`);
              const match = issueBody.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const sourceUrl = parseField('Source GitHub Enterprise Server Instance');
            const sourceOrg = parseField('Source Organization');
            const targetOrg = parseField('Target GitHub Enterprise Cloud Organization');
            const migrationType = parseField('Migration Type');
            const repositories = parseField('Repository Names');
            
            core.setOutput('source-url', sourceUrl);
            core.setOutput('source-org', sourceOrg);
            core.setOutput('target-org', targetOrg);
            core.setOutput('migration-type', migrationType);
            core.setOutput('repositories', repositories);
            
            console.log('Parsed data:', { sourceUrl, sourceOrg, targetOrg, migrationType, repositories });
      
      - name: Update issue - Starting migration
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ðŸš€ **Migration Process Started**\n\n` +
                    `- **Source:** ${{ steps.parse.outputs.source-url }}\n` +
                    `- **Source Org:** ${{ steps.parse.outputs.source-org }}\n` +
                    `- **Target Org:** ${{ steps.parse.outputs.target-org }}\n` +
                    `- **Type:** ${{ steps.parse.outputs.migration-type }}\n\n` +
                    `The migration process is now initializing...`
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: ['in-progress']
            });
            
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              name: 'pending'
            });
      
      - name: Install GitHub Enterprise Importer CLI
        run: |
          gh extension install github/gh-gei
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Validate secrets
        uses: actions/github-script@v7
        with:
          script: |
            const ghesPatExists = '${{ secrets.GHES_PAT }}' !== '';
            const gheCloudPatExists = '${{ secrets.GHE_CLOUD_PAT }}' !== '';
            
            if (!ghesPatExists || !gheCloudPatExists) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: `âŒ **Migration Failed - Missing Secrets**\n\n` +
                      `Required secrets are not configured:\n` +
                      `- GHES_PAT: ${ghesPatExists ? 'âœ…' : 'âŒ'}\n` +
                      `- GHE_CLOUD_PAT: ${gheCloudPatExists ? 'âœ…' : 'âŒ'}\n\n` +
                      `Please contact your administrator to configure the required secrets.`
              });
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: ['failed']
              });
              
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                name: 'in-progress'
              }).catch(() => {});
              
              core.setFailed('Required secrets are not configured');
            }
      
      - name: Generate migration log path
        id: log-path
        run: |
          LOG_PATH="migration-logs/$(date +%Y%m%d-%H%M%S)-issue-${{ github.event.issue.number }}"
          mkdir -p "$LOG_PATH"
          echo "path=$LOG_PATH" >> $GITHUB_OUTPUT
      
      - name: Get repositories to migrate
        id: get-repos
        uses: actions/github-script@v7
        with:
          script: |
            const sourceUrl = '${{ steps.parse.outputs.source-url }}'.trim().replace(/\/+$/, '');
            const sourceOrg = '${{ steps.parse.outputs.source-org }}';
            const migrationType = '${{ steps.parse.outputs.migration-type }}';
            const repositoriesInput = '${{ steps.parse.outputs.repositories }}';
            
            // Extract hostname from URL
            const sourceHost = sourceUrl.replace(/^https?:\/\//, '').split('/')[0];
            
            console.log('Source Host:', sourceHost);
            console.log('Source Org:', sourceOrg);
            console.log('Migration Type:', migrationType);
            
            let repositories = [];
            
            if (migrationType === 'All repositories') {
              // Use fetch to list all repositories from source GHES with pagination
              let page = 1;
              let hasMore = true;
              
              while (hasMore) {
                const response = await fetch(`https://${sourceHost}/api/v3/orgs/${sourceOrg}/repos?per_page=100&page=${page}`, {
                  headers: {
                    'Authorization': `token ${{ secrets.GHES_PAT }}`,
                    'Accept': 'application/vnd.github.v3+json'
                  }
                });
                
                if (!response.ok) {
                  throw new Error(`Failed to fetch repositories: ${response.status} ${response.statusText}`);
                }
                
                const repos = await response.json();
                
                if (repos.length === 0) {
                  hasMore = false;
                } else {
                  repositories.push(...repos.map(repo => repo.name));
                  console.log(`Fetched page ${page}: ${repos.length} repositories`);
                  
                  // Check if there are more pages
                  if (repos.length < 100) {
                    hasMore = false;
                  } else {
                    page++;
                  }
                }
              }
              
              console.log(`Found ${repositories.length} total repositories:`, repositories);
            } else {
              // Parse specific repositories list
              repositories = repositoriesInput
                .split(/[\n,]/)
                .map(r => r.trim())
                .filter(r => r.length > 0);
              console.log(`Migrating ${repositories.length} specific repositories:`, repositories);
            }
            
            core.setOutput('repositories', JSON.stringify(repositories));
            core.setOutput('source-host', sourceHost);
            return repositories;
      
      - name: Authenticate to target GHEC
        run: |
          echo "${{ secrets.GHE_CLOUD_PAT }}" | gh auth login --hostname customersuccess.ghe.com --with-token
      
      - name: Migrate repositories
        id: migrate
        uses: actions/github-script@v7
        with:
          script: |
            const repositories = JSON.parse('${{ steps.get-repos.outputs.repositories }}');
            const sourceUrl = '${{ steps.parse.outputs.source-url }}'.trim().replace(/\/+$/, '');
            const sourceOrg = '${{ steps.parse.outputs.source-org }}';
            const targetOrg = '${{ steps.parse.outputs.target-org }}';
            const sourceHost = '${{ steps.get-repos.outputs.source-host }}';
            const logPath = '${{ steps.log-path.outputs.path }}';
            const ghesApiUrl = `https://${sourceHost}/api/v3`;
            
            console.log('Starting migration process...');
            console.log('Source:', sourceUrl);
            console.log('Source Org:', sourceOrg);
            console.log('Target Org:', targetOrg);
            console.log('GHES API URL:', ghesApiUrl);
            console.log('Repositories to migrate:', repositories);
            
            const childProcess = require('child_process');
            const util = require('util');
            const execAsync = util.promisify(childProcess.exec);
            
            let successCount = 0;
            let failureCount = 0;
            const failures = [];
            
            for (const repo of repositories) {
              console.log(`\n=== Migrating repository: ${repo} ===`);
              
              try {
                const command = `gh gei migrate-repo \
                  --github-source-org "${sourceOrg}" \
                  --source-repo "${repo}" \
                  --github-target-org "${targetOrg}" \
                  --target-repo "${repo}" \
                  --ghes-api-url "${ghesApiUrl}" \
                  --target-api-url "https://api.customersuccess.ghe.com" \
                  --wait \
                  --verbose 2>&1 | tee -a "${logPath}/${repo}-migration.log"`;
                
                const { stdout, stderr } = await execAsync(command, {
                  env: {
                    ...process.env,
                    GH_PAT: '${{ secrets.GHE_CLOUD_PAT }}',
                    GH_SOURCE_PAT: '${{ secrets.GHES_PAT }}',
                    GITHUB_TOKEN: '${{ secrets.GHE_CLOUD_PAT }}'
                  }
                });
                
                console.log(stdout);
                if (stderr) console.error(stderr);
                
                successCount++;
                console.log(`âœ… Successfully migrated: ${repo}`);
              } catch (error) {
                failureCount++;
                failures.push(repo);
                console.error(`âŒ Failed to migrate ${repo}:`, error.message);
                
                // Continue with next repo instead of stopping
                continue;
              }
            }
            
            console.log('\n=== Migration Summary ===');
            console.log(`Total: ${repositories.length}`);
            console.log(`Success: ${successCount}`);
            console.log(`Failed: ${failureCount}`);
            if (failures.length > 0) {
              console.log('Failed repositories:', failures);
            }
            
            core.setOutput('success-count', successCount);
            core.setOutput('failure-count', failureCount);
            core.setOutput('failed-repos', JSON.stringify(failures));
            
            // Only fail the step if ALL migrations failed
            if (failureCount === repositories.length) {
              throw new Error('All repository migrations failed');
            }
      
      - name: Upload migration logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-logs-${{ github.event.issue.number }}
          path: ${{ steps.log-path.outputs.path }}
          retention-days: 30
      
      - name: Update issue - Migration results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const migrationSuccess = '${{ steps.migrate.outcome }}' === 'success';
            const successCount = '${{ steps.migrate.outputs.success-count }}' || '0';
            const failureCount = '${{ steps.migrate.outputs.failure-count }}' || '0';
            const failedRepos = '${{ steps.migrate.outputs.failed-repos }}' || '[]';
            const repositories = JSON.parse('${{ steps.get-repos.outputs.repositories }}');
            
            let body = '';
            
            if (migrationSuccess && failureCount === '0') {
              body = `âœ… **Migration Completed Successfully**\n\n` +
                     `All ${successCount} repositories have been migrated to the target organization.\n\n` +
                     `**Details:**\n` +
                     `- Source: ${{ steps.parse.outputs.source-url }}\n` +
                     `- Source Org: ${{ steps.parse.outputs.source-org }}\n` +
                     `- Target Org: ${{ steps.parse.outputs.target-org }}\n` +
                     `- Type: ${{ steps.parse.outputs.migration-type }}\n` +
                     `- Migrated: ${repositories.join(', ')}\n\n` +
                     `Migration logs are available in the workflow artifacts.`;
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: ['completed']
              });
            } else if (migrationSuccess && failureCount > '0') {
              const failed = JSON.parse(failedRepos);
              body = `âš ï¸ **Migration Partially Completed**\n\n` +
                     `Some repositories failed to migrate.\n\n` +
                     `**Summary:**\n` +
                     `- Total: ${repositories.length}\n` +
                     `- Success: ${successCount}\n` +
                     `- Failed: ${failureCount}\n\n` +
                     `**Failed repositories:**\n${failed.map(r => `- ${r}`).join('\n')}\n\n` +
                     `**Details:**\n` +
                     `- Source: ${{ steps.parse.outputs.source-url }}\n` +
                     `- Source Org: ${{ steps.parse.outputs.source-org }}\n` +
                     `- Target Org: ${{ steps.parse.outputs.target-org }}\n\n` +
                     `Please check the workflow logs and artifacts for details.`;
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: ['partial-failure']
              });
            } else {
              body = `âŒ **Migration Failed**\n\n` +
                     `The migration encountered errors. Please check the workflow logs and artifacts for details.\n\n` +
                     `**Troubleshooting:**\n` +
                     `1. Verify PAT tokens have correct permissions\n` +
                     `2. Check repository names are correct\n` +
                     `3. Ensure source repositories are accessible\n` +
                     `4. Review migration logs in workflow artifacts`;
              
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                labels: ['failed']
              });
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: body
            });
            
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              name: 'in-progress'
            }).catch(() => {});
      
      - name: Close issue on success
        if: steps.migrate.outcome == 'success' && steps.migrate.outputs.failure-count == '0'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              state: 'closed',
              state_reason: 'completed'
            });

