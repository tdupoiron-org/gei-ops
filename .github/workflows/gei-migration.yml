name: GEI Migration Workflow

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write
  contents: read

jobs:
  process-migration:
    if: contains(github.event.issue.labels.*.name, 'migration') && contains(github.event.issue.labels.*.name, 'pending')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Parse issue form
        id: parse
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = context.payload.issue.body;
            
            // Parse the issue form data
            const parseField = (fieldName) => {
              const regex = new RegExp(`### ${fieldName}\\s*([\\s\\S]*?)(?=###|$)`);
              const match = issueBody.match(regex);
              return match ? match[1].trim() : '';
            };
            
            const sourceUrl = parseField('Source GitHub Enterprise Server URL');
            const targetOrg = parseField('Target GitHub Enterprise Cloud Organization');
            const migrationType = parseField('Migration Type');
            const repositories = parseField('Repository Names');
            
            core.setOutput('source-url', sourceUrl);
            core.setOutput('target-org', targetOrg);
            core.setOutput('migration-type', migrationType);
            core.setOutput('repositories', repositories);
            
            console.log('Parsed data:', { sourceUrl, targetOrg, migrationType, repositories });
      
      - name: Update issue - Starting migration
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `ðŸš€ **Migration Process Started**\n\n` +
                    `- **Source:** ${{ steps.parse.outputs.source-url }}\n` +
                    `- **Target Org:** ${{ steps.parse.outputs.target-org }}\n` +
                    `- **Type:** ${{ steps.parse.outputs.migration-type }}\n\n` +
                    `The migration process is now initializing...`
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: ['in-progress']
            });
            
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              name: 'pending'
            });
      
      - name: Install GitHub Enterprise Importer CLI
        run: |
          gh extension install github/gh-gei
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Validate credentials
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `âœ… **Validation Complete**\n\n` +
                    `GitHub Enterprise Importer CLI installed successfully.\n\n` +
                    `âš ï¸ **Note:** This is a simplified workflow. For actual migrations, you'll need to:\n` +
                    `- Configure GHES and GHE Cloud PAT tokens as secrets\n` +
                    `- Run the actual GEI migration commands\n` +
                    `- Handle migration logs and errors\n\n` +
                    `See the [GEI documentation](https://docs.github.com/en/migrations/using-github-enterprise-importer) for details.`
            });
      
      - name: Complete migration
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              body: `âœ¨ **Migration Workflow Complete**\n\n` +
                    `The basic workflow has been executed successfully.\n\n` +
                    `**Next Steps:**\n` +
                    `1. Configure the required secrets (GHES_PAT, GHE_CLOUD_PAT)\n` +
                    `2. Implement actual GEI migration commands\n` +
                    `3. Add error handling and retry logic\n` +
                    `4. Set up notifications for completion`
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              labels: ['completed']
            });
            
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              name: 'in-progress'
            }).catch(() => {});
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              state: 'closed'
            });
